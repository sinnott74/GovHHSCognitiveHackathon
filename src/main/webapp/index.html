<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Speech Detection</title>
  <link rel="stylesheet" type="text/css" href="css/styles.css">
</head>
<body>
	<button type="button" id="record">ðŸŽ¤ Start Recording</button>
  	<div class="words"></div>

<script>

   const playText = "ðŸŽ¤ Start Recording";
   const stopText = "â—¼ Stop Recording";
  window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.interimResults = true;
  let p = document.createElement('p');
  const words = document.querySelector('.words');
  words.appendChild(p);
  recognition.addEventListener('result', e => {
    const transcript = Array.from(e.results)
      .map(result => result[0])
      .map(result => result.transcript)
      .join('');

      p.textContent = transcript;

      if (e.results[0].isFinal) {  	  
    	sendSentenceToServer(transcript);
        
    	p = document.createElement('p');
        words.appendChild(p);
      }
  });
  
  // Restart when it stops
  recognition.addEventListener('end', restart);
  
  const recordButton = document.querySelector('#record');
  recordButton.addEventListener('click', toggleRecording)
  
  function restart(){
	  let isRecording = recordButton.dataset.recording;
	  if(isRecording) {
		  recognition.start();
	  }
  }
  
  recognition.addEventListener('error', e => console.log(e));
  
  let sendSentenceToServer = function(text) {
	  fetch("/GovHHSCognitiveHackathon/api/nlu", {method: "POST", body: text});
  }
 
 
  
  function toggleRecording(){
	  let isRecording = recordButton.dataset.recording;
	  if(isRecording) {
		  console.log('stopping');
		  recognition.stop();
		  recordButton.removeAttribute('data-recording');
		  recordButton.textContent = playText;
	  } else {
		  console.log('starting');
		  recognition.start();
		  recordButton.setAttribute('data-recording', 'true');
		  recordButton.textContent = stopText;
	  }
	  
  }
  
  
  /* fetch("/GovHHSCognitiveHackathon/api/nlu")
  .then(response => response.text())
  .then(data => console.log(data))
  .catch(e => console.log(e)); */
  
</script>
</body>
</html>